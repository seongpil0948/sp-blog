# What is LDAP?

LDAP(Lightweight Directory Access Protocol) 는 디렉터리 서비스를 위한 프로토콜이다.   
디렉터리 서비스는 사용자, 그룹, 서비스등의 정보를 저장하고 검색하기 위한 서비스이다.   

## Architecture

### LDAP Server
### Server
- host: `192.168.0.103`

### Client
- host: `192.168.0.102`

### Directory Information Tree(DIT)
- LDAP 서버에 저장된 데이터의 계층적 구조를 나타내는 트리 구조
- 각 노드는 `entry`라고 불리는 객체를 가지고 있다.
- `entry`는 `attribute`와 `value`로 구성되어 있다.
- `attribute`는 `value`의 집합이며 `objectClass`를 포함한다.
- `objectClass`는 `entry`의 타입을 나타낸다.
- `entry`는 `dn(Distinguished Name)`으로 식별된다.
- dc(도메인 컴포넌트)는 LDAP 트리의 루트를 나타내는 컴포넌트이다.
  - 여러 개의 dc를 사용하여 트리 내에 여러 도메인을 만들 수 있습니다.
- cn(커먼 네임)은 LDAP 트리의 노드를 나타내는 컴포넌트이다.
  - CN은 항목을 식별하는 데 사용되는 고유한 이름입니다.
  - CN은 사용자 이름, 그룹 이름 또는 호스트 이름과 같은 항목과 관련된 의미 있는 이름을 포함해야 합니다.
  - 여러 개의 cn을 사용하여 단일 항목을 식별할 수 있습니다.
- sn(서브네임)은 사용자의 성을 나타내는 데 사용됩니다.
- givenName은 사용자의 이름을 나타내는 데 사용됩니다.
- uid(사용자 ID)는 사용자의 고유 식별자를 나타내는 데 사용됩니다.
- gid(그룹 ID)는 그룹의 고유 식별자를 나타내는 데 사용됩니다.
- ou(조직 단위)는 조직의 단위를 나타내는 데 사용됩니다.
- mail은 사용자의 이메일 주소를 나타내는 데 사용됩니다.
- l(로케이션)은 사용자의 위치를 나타내는 데 사용됩니다.
- st(주)는 사용자의 주를 나타내는 데 사용됩니다.
- c(국가)는 사용자의 국가를 나타내는 데 사용됩니다.
- telephoneNumber는 사용자의 전화 번호를 나타내는 데 사용됩니다.
- homeDirectory는 사용자의 홈 디렉터리를 나타내는 데 사용됩니다.
- objectClass: entry의 타입을 나타낸다.
  - `inetOrgPerson` : 사용자를 나타낸다.
  - `organizationalUnit` : 조직을 나타낸다.
- loginShell: 사용자의 로그인 쉘을 나타낸다.
- EXAMPLE
  - `dc=abacus,dc=co,dc=kr`는 `abacus`라는 조직의 `co.kr` 도메인을 나타낸다.
  - `cn=admin,dc=abacus,dc=co,dc=kr`는 `abacus` 조직의 관리자를 나타낸다.
  - `cn=developer,dc=convergence,dc=abacus,dc=co,dc=kr`는 `abacus` 조직의 사용자 그룹을 나타낸다.

# Install OpenLDAP to server
```bash
sudo dnf install openldap openldap-servers openldap-clients
```
## Configure LDAP Server
> slapd.conf - configuration file for slapd, the stand-alone LDAP daemon
먼저 어떻게 설정을 적용할지 확인해보자.
## Format slapd.conf
The general format of slapd.conf is as follows:
```
# comment - these options apply to every database
**<global configuration options>**
# first database definition & configuration options
database <backend 1 type>
<configuration options specific to backend 1>
# subsequent database definitions & configuration options
...
```
## <global configuration options>
Arguments that should be replaced by actual text are shown in brackets

### access to <what> [ by <who> <access> <control> ]+
한 명 이상의 요청자(<who>로 지정)가 일련의 항목 및/또는 속성(<what>로 지정)에 대한 액세스 권한(<access>로 지정)을 부여합니다.  


## Apply configuration
### configure slapd.conf
```bash
vi /etc/openldap/slapd.conf
# Add the following lines

# add base DN LDAP tree 
suffix "dc=abacus,dc=co.kr"

# add root DN
rootdn "cn=admin,dc=abacus,dc=co.kr"

# add root password
rootpw {SSHA}kingconvergence
```
- `suffix` : 이 백엔드 데이터베이스에 전달될 쿼리의 DN 접미사를 지정합니다.
- `rootdn` : 이 백엔드 데이터베이스에 대한 관리자 DN을 지정합니다.
- `rootpw` : 이 백엔드 데이터베이스에 대한 관리자 암호를 지정합니다.
### Start slapd
```bash
sudo systemctl start slapd
sudo systemctl enable slapd
```

# Configure LDAP Client
## Install LDAP client
```bash
sudo dnf install openldap-clients
```
## Configure LDAP client
```bash
vi /etc/openldap/ldap.conf
# Add the following lines
BASE    dc=abacus,dc=co,dc=kr
URI     ldap://192.168.0.103
```

## Check LDAP server from client
```bash
ldapsearch -x -b "dc=abacus,dc=co,dc=kr" 
```

# Operations utilities
## ldapsearch
> LDAP 서버에 연결하여 검색을 수행하는 명령어

### Options
- `x` : simple authentication
- `b` : search base
- `H` : URI
- `W` : prompt for bind password

## ldapadd
> LDAP 서버에 연결하여 entry를 추가하는 명령어
> `ldif` 파일을 사용하여 entry를 추가할 수 있다.

### Options
- `x` : simple authentication
- `D` : bind DN
- `W` : prompt for bind password
- `f` : file

# Example
### Add user `admin`  in `abacus.co.kr` with organization `convergence` 
```bash
ldapadd -x -D "cn=admin,dc=abacus,dc=co,dc=kr" -W -f add_entry.ldif
```
### Add user in domain `abacus.co.kr` 
- uid: `1501`
- gid: `150`
- mail: `sejin@gmail.com`
- loginShell: `/bin/bash`
- homeDirectory: `/home/sejin`
- objectClass: `inetOrgPerson`
- group: `developer`
- organization: `convergence`
- sn: `park`
- telephoneNumber: `010-1234-5678`
- givenName: `sejin`
- password: `passpass`

write `user-sejin.ldif`
```bash
$ mkdir -p ldifs
$ vi ldifs/user-sejin.ldif
```
input the following lines
```ldif
dn: uid=1501,gid=151,ou=convergence,dc=abacus,dc=co,kr
objectClass: inetOrgPerson
uid: 1501
gidNumber: 151
mail: sejin@gmail.com
loginShell: /bin/bash
homeDirectory: /home/sejin
cn: sejin park
sn: park
givenName: sejin
telephoneNumber: 010-1234-5678
userPassword: {CRYPT}passpass
memberUid: 1501
memberOf: cn=developer,dc=abacus,dc=co,kr
```

add user
```bash
ldapadd -x -D "cn=admin,dc=abacus,dc=co,dc=kr" -W -f add_user.ldif
```

### Add group `developer` in `abacus.co.kr` with organization `convergence` 
write `add_group.ldif`
```bash
$ vi add_group.ldif
```
input the following lines
```ldif
dn: cn=developer,dc=abacus,dc=co,kr
objectClass: groupOfNames
cn: developer
member: uid=1501,gid=151,ou=convergence,dc=abacus,dc=co,kr
```
add group
```bash
ldapadd -x -D "cn=admin,dc=abacus,dc=co,dc=kr" -W -f add_group.ldif
```

### Search all entries in abaucs.co.kr
```bash
ldapsearch -x -b "dc=abacus,dc=co,dc=kr" -H ldap://192.168.0.103
```
### Search all entries in `abacus.co.kr` and organization `convergence` 
```bash
ldapsearch -x -b "ou=convergence,dc=abacus,dc=co,dc=kr" -H ldap://192.168.0.103
```

### Search group `developer` in `abacus.co.kr`
```bash
ldapsearch -x -b "cn=developer,dc=abacus,dc=co,kr" -H ldap://192.168.0.103
or
ldapsearch -x -LLL -b dc=example,dc=com cn=developer -H ldap://192.168.0.103
```







# References
- [OpenLDAP](https://www.openldap.org/)
- [https://www.openldap.org/doc/admin26/quickstart.html](https://www.openldap.org/doc/admin26/quickstart.html)
- [https://linux.die.net/man/5/slapd.access](https://linux.die.net/man/5/slapd.access)